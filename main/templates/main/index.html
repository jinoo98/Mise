<!DOCTYPE html>
{% load static %}
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mise ìš”ë¦¬ì˜ ì¤€ë¹„ë¥¼ ìœ„í•œ ëª¨ë“  ê²ƒ</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Theme Variables -->
    <style>
        :root {
            --background: #FAFBFC;
            --foreground: #0f172a;
            --card: #ffffff;
            --card-foreground: #0f172a;
            --popover: #ffffff;
            --popover-foreground: #0f172a;
            --primary: #DC2626;
            --primary-foreground: #ffffff;
            --secondary: #FEF2F2;
            --secondary-foreground: #991B1B;
            --muted: #f1f5f9;
            --muted-foreground: #64748b;
            --accent: #f1f5f9;
            --accent-foreground: #0f172a;
            --destructive: #ef4444;
            --destructive-foreground: #f8fafc;
            --border: #e2e8f0;
            --input: #e2e8f0;
            --ring: #DC2626;
            --radius: 0.5rem;
        }

        body {
            background-color: #FAFBFC;
            /* red-50 to orange-50 approx */
            background-image: linear-gradient(to bottom right, #FAFBFC, #FAFBFC);
            color: var(--foreground);
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .card {
            background-color: var(--card);
            color: var(--card-foreground);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .tab-active {
            background-color: var(--background);
            color: var(--foreground);
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        .tab-inactive {
            color: var(--muted-foreground);
        }

        .tab-inactive:hover {
            color: var(--foreground);
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50 shadow-none">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 shadow-none">
            <div class="flex items-center gap-3">
                <div class="items-center">
                    <img src="{% static 'icon/Mise_Icon.png' %}" class="w-[45px] h-[45px] inline-block">
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-red-600">Mise</h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Mise En Place - ìš”ë¦¬ì˜ ì¤€ë¹„ë¥¼ ìœ„í•œ
                        ëª¨ë“  ê²ƒ</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 shadow-none">

        <!-- Tabs (Navigation) -->
        <div class="w-full mb-8 shadow-none">
            <div class="grid w-full grid-cols-3 bg-gray-100 p-1 rounded-lg mb-6 shadow-none">
                <a href="{% url 'index' %}"
                    class="tab-active flex flex-col items-center justify-center gap-1 py-3 rounded-xl text-xs font-bold transition-all">
                    <i data-lucide="chef-hat" class="w-4 h-4 text-[#E11D48]"></i>
                    <span>ë ˆì‹œí”¼ ì¶”ì¶œ</span>
                </a>
                <a href="{% url 'price' %}"
                    class="tab-inactive flex flex-col items-center justify-center gap-1 py-3 rounded-xl text-xs font-bold transition-all">
                    <i data-lucide="calculator" class="w-4 h-4"></i>
                    <span class="text-slate-900">ë‹¨ê°€ ê³„ì‚°</span>
                </a>
                <a href="{% url 'matching' %}"
                    class="tab-inactive flex flex-col items-center justify-center gap-1 py-3 rounded-xl text-xs font-bold transition-all">
                    <i data-lucide="cooking-pot" class="w-4 h-4"></i>
                    <span>ì¬ë£Œ ë§¤ì¹­</span>
                </a>
            </div>
        </div>

        <!-- Content: Extractor -->
        <div id="content-extractor" class="space-y-6">

            <!-- Search Section -->
            <div class="card p-6 shadow-none">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold flex items-center gap-2 mb-1">
                        <i data-lucide="youtube" class="w-5 h-5 text-red-600"></i>
                        ìœ íŠœë¸Œ ë ˆì‹œí”¼ ê²€ìƒ‰
                    </h2>
                    <p class="text-sm text-gray-500">ìœ íŠœë¸Œ ì±„ë„ëª…ì´ë‚˜ ìš”ë¦¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>

                <form method="POST" class="flex flex-col gap-3" action="{% url 'search_recipe' %}">
                    {% csrf_token %}
                    <div class="flex gap-4 mb-1">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="search_type" value="channel"
                                class="text-red-600 focus:ring-red-500" checked>
                            <span class="text-sm font-medium text-gray-700">ì±„ë„ ê²€ìƒ‰</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="search_type" value="keyword"
                                class="text-red-600 focus:ring-red-500">
                            <span class="text-sm font-medium text-gray-700">ìš”ë¦¬ëª… ê²€ìƒ‰</span>
                        </label>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" name="search_query" id="youtube-input"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
                            placeholder="ìœ íŠœë²„ ì´ë¦„ì´ë‚˜ ìš”ë¦¬ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..." required>
                        <button type="submit"
                            class="btn-primary px-4 py-2 rounded-md flex items-center gap-2 font-medium whitespace-nowrap flex-shrink-0">
                            <i data-lucide="search" class="w-4 h-4"></i>
                            ê²€ìƒ‰
                        </button>
                    </div>
                </form>
            </div>

            <!-- Search Results -->
            {% if search_results %}
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <i data-lucide="list-video" class="w-5 h-5 text-red-600"></i>
                    ê²€ìƒ‰ ê²°ê³¼
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 shadow-none">
                    {% for video in search_results %}
                    <div class="card p-4 flex flex-col gap-3 shadow-none">
                        <div class="relative aspect-video rounded-md overflow-hidden bg-gray-100 h-60">
                            <a href="{{ video.url }}" target="_blank"><img src="{{ video.thumbnail }}"
                                    alt="{{ video.title }}" class="object-cover w-full h-full"></a>
                        </div>
                        <div class="font-medium text-lg line-clamp-2">{{ video.title }}</div>
                        <div class="text-sm text-gray-500 flex items-center gap-1">
                            <i data-lucide="youtube" class="w-3 h-3"></i>
                            <span class="truncate">{{ video.channel_name }}</span>
                        </div>
                        <form method="POST" class="mt-auto extract-form" action="{% url 'extract' %}">
                            {% csrf_token %}
                            <input type="hidden" name="youtube_url" value="{{ video.url }}">
                            <input type="hidden" name="thumbnail" value="{{ video.thumbnail }}">
                            <input type="hidden" name="video_title" value="{{ video.title }}">
                            <input type="hidden" name="channel_name" value="{{ video.channel_name }}">
                            <button type="submit"
                                class="w-full btn-primary py-2 rounded-md text-sm font-medium flex items-center justify-center gap-2">
                                ë ˆì‹œí”¼ ì¶”ì¶œ
                            </button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Recent Recipes List -->
            <div class="space-y-4">
                <h3 class="text-lg font-semibold text-gray-800">ìµœê·¼ ë ˆì‹œí”¼</h3>

                {% if recent_recipes %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    {% for recipe in recent_recipes %}
                    <div
                        class="card overflow-hidden shadow-none flex flex-col bg-white border border-gray-200 rounded-xl">

                        <a href="{{ recipe.youtube_url }}" target="_blank" class="block group overflow-hidden">
                            {% if recipe.thumbnail %}
                            <img src="{{ recipe.thumbnail }}"
                                class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105"
                                alt="{{ recipe.title }}">
                            {% else %}
                            <div
                                class="w-full h-48 bg-gray-100 flex items-center justify-center text-gray-400 group-hover:bg-gray-200 transition-colors">
                                <i data-lucide="image" class="w-12 h-12"></i>
                            </div>
                            {% endif %}
                        </a>

                        <div class="p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div>
                                    <h3 class="text-xl font-bold mb-1 text-gray-900 recipe-content cursor-pointer hover:text-blue-600"
                                        onclick="openRecipeModal('{{ recipe.recipe_title|escapejs }}', '{{ recipe.information|escapejs }}')">
                                        {{ recipe.recipe_title }}
                                    </h3>
                                    <div class="flex items-center gap-2 text-sm text-gray-500">
                                        <i data-lucide="youtube" class="w-4 h-4 text-red-600"></i>
                                        {{ recipe.youtuber }}
                                    </div>
                                </div>
                                <span
                                    class="bg-red-50 text-red-700 text-xs px-2 py-1 rounded-full font-medium flex items-center gap-1">
                                    <i data-lucide="chef-hat" class="w-3 h-3"></i>
                                    ë ˆì‹œí”¼
                                </span>
                            </div>
                            <div class="flex items-start gap-2">

                                <div class="flex-1 bg-gray-50 rounded-lg overflow-hidden border border-gray-200">
                                    <details class="group">
                                        <summary
                                            class="flex items-center justify-between p-3 cursor-pointer list-none bg-white hover:bg-gray-50 transition-colors">
                                            <h4 class="font-medium flex items-center gap-2 m-0 text-xs shrink-0">
                                                <i data-lucide="book-open" class="w-3.5 h-3.5 text-red-600"></i>
                                                ìš”ì•½ ë ˆì‹œí”¼
                                            </h4>
                                            <span class="transition-transform duration-300 group-open:rotate-180">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                                    viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="m6 9 6 6 6-6" />
                                                </svg>
                                            </span>
                                        </summary>
                                        <div class="p-3 border-t border-gray-100 bg-white">
                                            <div class="recipe-content prose prose-slate max-w-none text-xs">
                                                {{ recipe.recipe_html|safe }}
                                            </div>
                                        </div>
                                    </details>
                                </div>

                                <button
                                    onclick="startCooking('{{ recipe.recipe_title|escapejs }}','{{ recipe.ingredients|escapejs }}','{{ recipe.recipe|escapejs }}')"
                                    class="btn-primary px-4 rounded-lg text-xs font-bold flex items-center justify-center whitespace-nowrap self-start h-[46px]">
                                    ìš”ë¦¬ ì‹œì‘
                                </button>

                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="card border-dashed p-12 flex flex-col items-center justify-center text-center">
                    <i data-lucide="youtube" class="w-16 h-16 text-gray-300 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-1">ë ˆì‹œí”¼ë¥¼ ì¶”ì¶œí•´ë³´ì„¸ìš”</h3>
                    <p class="text-sm text-gray-500">
                        ìƒë‹¨ì˜ ê²€ìƒ‰ì°½ì— ìš”ë¦¬ëª…ì´ë‚˜ ì±„ë„ëª…ì„ ì…ë ¥í•˜ì—¬<br>ì²« ë²ˆì§¸ ë ˆì‹œí”¼ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”.
                    </p>
                </div>
                {% endif %}
            </div>

        </div>

        <!-- Tab Content: Match (Placeholder) -->
        <div id="content-match" class="hidden card p-12 text-center">
            <i data-lucide="cooking-pot" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤</h3>
            <p class="text-sm text-gray-500">ì¬ë£Œ ë§¤ì¹­ ê¸°ëŠ¥ì€ ê³§ ì œê³µë  ì˜ˆì •ì…ë‹ˆë‹¤.</p>
        </div>

        <div id="loading-overlay"
            class="fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[9999] flex items-center justify-center hidden">
            <div
                class="bg-white p-8 rounded-3xl shadow-2xl flex flex-col items-center gap-6 max-w-sm w-full mx-4 border border-slate-100">

                <div id="step-icon"
                    class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center text-4xl animate-bounce">
                    ğŸ¬
                </div>

                <div class="text-center space-y-2">
                    <h3 id="step-title" class="text-xl font-bold text-slate-800">ìœ íŠœë¸Œ ì˜ìƒ ë¶„ì„ ì¤‘...</h3>
                    <p id="step-description" class="text-sm text-slate-500">ì˜ìƒì˜ í•µì‹¬ ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div class="w-full space-y-2">
                    <div class="flex justify-between text-xs font-bold text-red-600 mb-1">
                        <span id="step-percent-text">0%</span>
                        <span>Processing...</span>
                    </div>
                    <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden border border-slate-200">
                        <div id="step-bar"
                            class="bg-gradient-to-r from-orange-500 to-red-600 h-full transition-all duration-500 ease-out"
                            style="width: 0%"></div>
                    </div>
                </div>

                <p class="text-[10px] text-slate-400">ë¶„ì„ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì°½ì„ ë‹«ì§€ ë§ˆì„¸ìš”.</p>
            </div>
        </div>
        <div id="cooking-modal"
            class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[9999] hidden flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                    <h2 id="modal-title" class="text-xl text-gray-800">ìš”ë¦¬ ì¤€ë¹„</h2>
                    <button onclick="closeCookingModal()" class="text-gray-400 hover:text-gray-600">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <div id="modal-body" class="p-8 overflow-y-auto flex-1">
                </div>

                <div class="p-6 border-t bg-gray-50 flex justify-end gap-3" id="modal-footer">
                    <div class="flex items-center gap-2">
                        <p id="modal-step" class="text-gray-800"></p>
                    </div>
                    <button id="modal-prev" class="px-6 py-2 rounded-xl font-medium text-gray-500 hidden">ì´ì „</button>
                    <button id="modal-next"
                        class="px-6 py-2 bg-red-600 text-white rounded-xl font-medium hover:bg-red-700">ë‹¤ìŒ</button>
                </div>
            </div>
        </div>

        <div id="recipeModal"
            class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center p-4">
            <div
                class="bg-white rounded-xl max-w-lg w-full p-8 shadow-2xl overflow-y-auto max-h-[80vh] relative border-none">
                <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="closeRecipeModal()"
                        class="text-gray-400 hover:text-red-500 text-2xl p-2 transition-colors">&times;</button>
                </div>
                <div id="modalContent" class="text-gray-600 whitespace-pre-wrap leading-relaxed font-medium">
                </div>
                <div class="mt-8 text-right">
                    <button onclick="closeRecipeModal()"
                        class="bg-gray-800 text-white px-8 py-3 rounded-xl font-bold text-sm hover:bg-gray-700 transition-all shadow-lg">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();
        let countdownInterval = null;

        const examples = [
            "ë°±ì¢…ì› PAIK JONG WON", "ìŠ¤íŒ¸ë§ˆìš”ë®ë°¥",
            "1ë¶„ìš”ë¦¬ ëšë”±ì´í˜•", "ì œìœ¡ë³¶ìŒ",
            "ì„±ì‹œê²½ SUNG SI KYUNG", "ëœì¥ì°Œê°œ",
            "ìœ¡ì‹ë§¨ YOOXICMAN", "ìŠ¤í…Œì´í¬",
            "ì¿ í‚¹íŠ¸ë¦¬ Cooking tree", "ì´ˆì½” ì¼€ì´í¬",
            "ìŠ¹ìš°ì•„ë¹ ", "ë§ˆë¼íƒ•",
            "í•˜ë£¨í•œë¼", "ê³„ë€ë§ì´",
            "í‘œì •ì› Pyojungwon", "ì•Œë¦¬ì˜¤ì˜¬ë¦¬ì˜¤",
            "ìˆ˜ëê°„ ì •ì…°í”„", "ê°ˆë¹„ì°œ",
            "ì¡°ìŠ¹ì—°ì˜ íƒêµ¬ìƒí™œ(ìš”ë¦¬í¸)", "ë¼ë”°ëšœì´",
            "ì§‘ë‚˜ê°„ ì•„ë“¤", "ìˆœë‘ë¶€ì°Œê°œ",
            "ì·¨ìš”ë‚¨", "í†µì‚¼ê²¹ ì˜¤ë¸êµ¬ì´"
        ];
        let i = 0;
        const input = document.getElementById('youtube-input');

        setInterval(() => {
            input.placeholder = `ì˜ˆ: ${examples[i++ % examples.length]}...`;
        }, 2000); // 2ì´ˆë§ˆë‹¤ ë³€ê²½

        document.addEventListener("DOMContentLoaded", function () {
            const recipeContents = document.querySelectorAll('.recipe-content');
            recipeContents.forEach(content => {
                // "## ìŒì‹ëª…:" ì´ë¼ëŠ” ê¸€ìë¥¼ ì°¾ì•„ì„œ ë¹ˆ ì¹¸ìœ¼ë¡œ ë°”ê¿ˆ
                content.innerHTML = content.innerHTML.replace(/## ìŒì‹ëª…:/g, '');
                content.innerHTML = content.innerHTML.replace(/#/g, '');
            });
        });

        // ë‹¨ê³„ ì„¤ì • ë°ì´í„°
        const loadingSteps = {
            youtube: { icon: 'ğŸ¬', title: 'ìœ íŠœë¸Œ ì—°ê²° ì¤‘', desc: 'ì˜ìƒì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.', percent: 15 },
            audio: { icon: 'ğŸ”Š', title: 'ì˜¤ë””ì˜¤ ì¶”ì¶œ ì¤‘', desc: 'ìŒì„± ë°ì´í„°ë¥¼ ë¶„ë¦¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.', percent: 30 },
            text: { icon: 'ğŸ“', title: 'í…ìŠ¤íŠ¸ ë³€í™˜ ì¤‘', desc: 'AIê°€ í…ìŠ¤íŠ¸ ë°ì´í„°ë¡œ ë³€í™˜ ì¤‘ì…ë‹ˆë‹¤.', percent: 50 },
            recipe: { icon: 'ğŸ‘¨â€ğŸ³', title: 'ë ˆì‹œí”¼ ìƒì„± ì¤‘', desc: 'ì¡°ë¦¬ ìˆœì„œì™€ ì¬ë£Œë¥¼ ì •ë¦¬ ì¤‘ì…ë‹ˆë‹¤.', percent: 60 },
            search: { icon: 'ğŸ”', title: 'ì¸í„°ë„· ìµœì €ê°€ ê²€ìƒ‰', desc: 'ì¬ë£Œë³„ ì‹œì¥ ë‹¨ê°€ë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤.', percent: 70 },
            done: { icon: 'âœ…', title: 'ì™„ë£Œ!', desc: 'ëª¨ë“  ë¶„ì„ì´ ëë‚¬ìŠµë‹ˆë‹¤.', percent: 100 }
        };

        function updateLoadingStep(stepKey) {
            const step = loadingSteps[stepKey];
            if (!step) return;

            document.getElementById('step-icon').textContent = step.icon;
            document.getElementById('step-title').textContent = step.title;
            document.getElementById('step-description').textContent = step.desc;
            document.getElementById('step-bar').style.width = step.percent + '%';
            document.getElementById('step-percent-text').textContent = step.percent + '%';
        }

        // ë ˆì‹œí”¼ ì¶”ì¶œ í¼ì´ ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ(ê²€ìƒ‰ ê²°ê³¼ë§ˆë‹¤ í•˜ë‚˜ì”©), ëª¨ë“  ì¶”ì¶œ í¼ì— ì´ë²¤íŠ¸ë¥¼ ê²ë‹ˆë‹¤.
        document.querySelectorAll('.extract-form').forEach(form => {
            form.addEventListener('submit', async function (e) {
                e.preventDefault(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€

                const overlay = document.getElementById('loading-overlay');
                const formData = new FormData(this);

                // 1. ë¡œë”©ì°½ í‘œì‹œ ë° ì²« ë‹¨ê³„ ì‹œì‘
                overlay.classList.remove('hidden');
                updateLoadingStep('youtube');

                // ê°€ì§œ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ (ì„œë²„ ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì‚¬ìš©ìë¥¼ ì•ˆì‹¬ì‹œí‚´)
                let currentStep = 0;
                const steps = ['audio', 'text', 'recipe', 'search'];
                const interval = setInterval(() => {
                    if (currentStep < steps.length) {
                        updateLoadingStep(steps[currentStep]);
                        currentStep++;
                    } else {
                        clearInterval(interval);
                    }
                }, 4000); // ì‹¤ì œ ì„œë²„ ì²˜ë¦¬ ì‹œê°„ì„ ê³ ë ¤í•˜ì—¬ 4ì´ˆ ì •ë„ë¡œ ì„¤ì •

                try {
                    // 2. ì¥ê³ ì˜ 'extract' ë·°ë¡œ ë°ì´í„° ì „ì†¡
                    const response = await fetch("{% url 'extract' %}", { // urls.pyì—ì„œ ìˆ˜ì •í•œ name ì‚¬ìš©
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest', // AJAX ìš”ì²­ì„ì„ ì•Œë¦¼
                        }
                    });

                    if (response.ok) {
                        // 3. ì™„ë£Œ ì‹œ ë§ˆì§€ë§‰ ë‹¨ê³„ í‘œì‹œ í›„ í˜ì´ì§€ ì´ë™
                        clearInterval(interval);
                        updateLoadingStep('done');
                        setTimeout(() => {
                            window.location.href = "{% url 'index' %}"; // ì™„ë£Œ í›„ ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™ (ì „ì²´ ë ˆì‹œí”¼ ëª©ë¡ ê°±ì‹  ìœ„í•´)
                        }, 1000);
                    } else {
                        throw new Error('ì„œë²„ ì—ëŸ¬ ë°œìƒ');
                    }

                } catch (error) {
                    console.error(error);
                    alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    overlay.classList.add('hidden');
                    clearInterval(interval);
                }
            });
        });
        let currentStep = 0;
        let recipeSteps = [];
        let recipeIngredients = "";

        function startCooking(title, ingredients, steps) {
            // 1. í—¤ë”('### ì¬ë£Œ') ì œê±°
            let rawIngredients = ingredients.replace('### ì¬ë£Œ', '').trim();

            // 2. ì¤„ ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•˜ë©´ì„œ ì†Œì œëª©ê³¼ '-' ê¸°í˜¸ ì‚­ì œ
            recipeIngredients = rawIngredients.split('\n').map(line => {
                let trimmedLine = line.trim();

                // ë¹ˆ ì¤„ì´ê±°ë‚˜ ì†Œì œëª©ì¸ ì¤„ì€ ì™„ì „íˆ ì œì™¸
                const headers = ['ì£¼ì¬ë£Œ', 'ë¶€ì¬ë£Œ', 'ì¡°ë¯¸ë£Œ', 'ì–‘ë…', 'ì†ŒìŠ¤'];
                const isHeader = headers.some(header => trimmedLine.includes(header));

                if (trimmedLine === "" || isHeader) {
                    return null; // ì œì™¸ ëŒ€ìƒ
                }

                // 3. '-' ê¸°í˜¸ ì‚­ì œ ë° íƒ­ ì¶”ê°€
                // ë§¨ ì•ì˜ '-'ì™€ ê³µë°±ì„ ì§€ìš°ê³  ì•ì— íƒ­(\t)ì„ ë¶™ì„
                let cleanLine = trimmedLine.replace(/^[-\s]+/, "");
                return '\t' + cleanLine;
            })
                .filter(line => line !== null) // ì œì™¸ëœ ì¤„(null) ì œê±°
                .join('\n')
                .trim();

            // ì¡°ë¦¬ ê³¼ì • ì²˜ë¦¬
            // / \*\* /g : ëª¨ë“  **ë¥¼ ì°¾ìœ¼ë¼ëŠ” ì •ê·œì‹ì…ë‹ˆë‹¤. (ë³„í‘œëŠ” íŠ¹ìˆ˜ë¬¸ìë¼ \ë¥¼ ë¶™ì—¬ì•¼ í•©ë‹ˆë‹¤)
            steps = steps.replace('### ê³¼ì •', '').replace(/\*\*/g, '').trim();
            recipeSteps = steps.split('\n').filter(s => s.trim() !== "");
            currentStep = 0;

            document.getElementById('cooking-modal').classList.remove('hidden');
            renderModalStep();
        }

        function renderModalStep() {
            const body = document.getElementById('modal-body');
            const title = document.getElementById('modal-title');
            const step = document.getElementById('modal-step');
            const nextBtn = document.getElementById('modal-next');
            const prevBtn = document.getElementById('modal-prev');

            // ë‹¨ê³„ ì´ë™ ì‹œ ê¸°ì¡´ íƒ€ì´ë¨¸ ë¬´ì¡°ê±´ ì •ì§€
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }

            step.innerText = `${currentStep} / ${recipeSteps.length}`;

            if (currentStep === 0) {
                title.innerText = "Step 0. ì¬ë£Œ ì¤€ë¹„í•˜ê¸°";
                nextBtn.disabled = true;
                nextBtn.style.opacity = "0.5";
                nextBtn.innerText = "ì¤€ë¹„ ì™„ë£Œ! ìš”ë¦¬ ì‹œì‘";

                body.innerHTML = `
        <div class="space-y-3"> 
            <div class="p-4 rounded-xl text-gray-800 leading-relaxed border text-left"
                 style="white-space: pre-line; font-weight: bold; tab-size: 2; -moz-tab-size: 2;">
                ${recipeIngredients}
            </div>
            <div class="flex items-center gap-3 p-2">
                <p class="text-gray-900 font-bold text-sm">ì•„ë˜ ì¬ë£Œë“¤ì´ ëª¨ë‘ ì¤€ë¹„ë˜ì—ˆë‚˜ìš”?</p>
                <button id="prep-checker" onclick="togglePrepCheck()" 
                        class="w-6 h-6 border-2 border-red-600 rounded flex items-center justify-center transition-colors">
                    <i data-lucide="check" id="check-icon" class="w-4 h-4 text-white hidden"></i>
                </button>
            </div>
        </div>`;

                if (typeof lucide !== 'undefined') lucide.createIcons();
                prevBtn.classList.add('hidden');
                nextBtn.onclick = () => { currentStep++; renderModalStep(); };

            } else if (currentStep <= recipeSteps.length) {
                nextBtn.disabled = false;
                nextBtn.style.opacity = "1";

                const stepIdx = currentStep - 1;
                const currentText = recipeSteps[stepIdx];

                // ì •ê·œì‹: ìˆ«ìì™€ ì‹œê°„ ë‹¨ìœ„ê°€ ë¶™ì–´ìˆëŠ”ì§€ í™•ì¸
                const timeRegex = /(\d+)\s*(ì´ˆ|ë¶„|ì‹œê°„)/;
                const hasTime = timeRegex.test(currentText);

                title.innerText = `Step ${currentStep}. ì¡°ë¦¬ ê³¼ì •`;

                body.innerHTML = `
        <div class="space-y-6 py-10 flex flex-col items-center">
            <p class="text-xl text-center font-semibold text-gray-800 leading-snug px-4">
                ${currentText}
            </p>
            
            <div id="timer-display-area" class="h-20 flex items-center justify-center w-full">
                ${hasTime ? `
                <button onclick="handleTimerClick('${currentText.replace(/'/g, "\\'")}')" 
                        class="flex items-center gap-2 bg-orange-100 text-orange-600 px-5 py-2.5 rounded-full font-bold text-sm hover:bg-orange-200 transition-all animate-pulse">
                    <i data-lucide="timer" class="w-4 h-4"></i>
                    íƒ€ì´ë¨¸ ì‹œì‘
                </button>
                ` : ''}
            </div>
        </div>`;

                if (typeof lucide !== 'undefined') lucide.createIcons();
                prevBtn.classList.remove('hidden');

                if (currentStep === recipeSteps.length) {
                    nextBtn.innerText = "ìš”ë¦¬ ì™„ë£Œ!";
                    nextBtn.onclick = () => closeCookingModal();
                } else {
                    nextBtn.innerText = "ë‹¤ìŒ ë‹¨ê³„";
                    nextBtn.onclick = () => { currentStep++; renderModalStep(); };
                }
            }
        }

        // íƒ€ì´ë¨¸ ì¶”ì¶œ ë° ì‹¤í–‰ í•¨ìˆ˜
        function handleTimerClick(text) {
            const timeRegex = /(\d+)\s*(ì´ˆ|ë¶„|ì‹œê°„)/g;
            let totalSeconds = 0;
            let match;

            // í…ìŠ¤íŠ¸ì—ì„œ ëª¨ë“  ì‹œê°„ ë‹¨ìœ„ë¥¼ í•©ì‚° (ì˜ˆ: 1ë¶„ 30ì´ˆ -> 90ì´ˆ)
            while ((match = timeRegex.exec(text)) !== null) {
                const value = parseInt(match[1]);
                const unit = match[2];
                if (unit === 'ì´ˆ') totalSeconds += value;
                else if (unit === 'ë¶„') totalSeconds += value * 60;
                else if (unit === 'ì‹œê°„') totalSeconds += value * 3600;
            }

            if (totalSeconds <= 0) return;

            const timerArea = document.getElementById('timer-display-area');
            let timeLeft = totalSeconds;

            if (countdownInterval) clearInterval(countdownInterval);

            countdownInterval = setInterval(() => {
                timeLeft--;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    timerArea.innerHTML = `
                <div class="flex flex-col items-center animate-bounce">
                    <span class="text-red-500 font-black text-xl">ğŸ”” ì‹œê°„ ì¢…ë£Œ!</span>
                    <button onclick="renderModalStep()" class="text-xs text-gray-400 underline mt-2">ë‹¤ì‹œ ì„¤ì •</button>
                </div>
            `;
                    return;
                }

                const min = Math.floor(timeLeft / 60);
                const sec = timeLeft % 60;
                timerArea.innerHTML = `
            <div class="flex flex-col items-center gap-1 bg-orange-50 px-6 py-2 rounded-2xl border border-orange-100">
                <span class="text-3xl font-mono font-black text-orange-600">
                    ${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}
                </span>
                <button onclick="stopTimer()" class="text-[10px] text-gray-400 underline">ì·¨ì†Œ</button>
            </div>
        `;
            }, 1000);
        }

        function stopTimer() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            renderModalStep();
        }

        function togglePrepCheck() {
            const nextBtn = document.getElementById('modal-next');
            const checker = document.getElementById('prep-checker');
            const icon = document.getElementById('check-icon');

            const isChecked = icon.classList.contains('hidden');

            if (isChecked) {
                // ì²´í¬ë¨
                icon.classList.remove('hidden');
                checker.classList.add('bg-red-600');
                nextBtn.disabled = false;
                nextBtn.style.opacity = "1";
            } else {
                // ì²´í¬ í•´ì œ
                icon.classList.add('hidden');
                checker.classList.remove('bg-red-600');
                nextBtn.disabled = true;
                nextBtn.style.opacity = "0.5";
            }
        }
        // ì´ì „ ë²„íŠ¼ í´ë¦­ ì‹œ
        document.getElementById('modal-prev').onclick = () => {
            if (currentStep > 0) {
                currentStep--;
                renderModalStep();
            }
        };

        // ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ ì‹œ (ì´ˆê¸° ì„¸íŒ…)
        document.getElementById('modal-next').onclick = () => {
            currentStep++;
            renderModalStep();
        };

        function closeCookingModal() {
            document.getElementById('cooking-modal').classList.add('hidden');
        }
        function openRecipeModal(title, info) {
            // ì œëª©ê³¼ ì •ë³´ ì±„ìš°ê¸°
            document.getElementById('modalTitle').innerText = title.replace("## ìŒì‹ëª…:", "");

            // ì²« ì¤„(ë³´í†µ "ìŒì‹ ì •ë³´" ë“±) ì œê±° ë¡œì§ ì ìš©
            const cleanedInfo = (info || "").replace(/^.*?\n/, '').trim();
            document.getElementById('modalContent').innerText = cleanedInfo || "ìƒì„¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";

            // ëª¨ë‹¬ ë³´ì´ê¸° (hidden í´ë˜ìŠ¤ ì œê±°)
            const modal = document.getElementById('recipeModal');
            modal.classList.remove('hidden');

            // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° ê¸°ëŠ¥ ì¶”ê°€
            modal.onclick = function (event) {
                if (event.target === modal) closeRecipeModal();
            };
        }

        function closeRecipeModal() {
            // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            document.getElementById('recipeModal').classList.add('hidden');
        }
    </script>
</body>

</html>